#!/usr/bin/env ruby

require 'optparse'

def help
  puts 'Usage: rrtmux [ssh options] hostname'
  puts '  Connects to a hostname using ssh and reattach or create a tmux session'
end

timeout = 0.125

if ARGV.empty? or ARGV.find {|arg| arg == '-h' or arg == '--help'}
  help
else
  while true
    system 'ssh', '-t', *ARGV, 'tmux att || tmux new'
    exit if $?.exitstatus == 0
    sleep timeout
    STDERR.puts "ssh failed, waiting for #{timeout} secs..."
    timeout *= 2 if timeout < 4
  end
end
